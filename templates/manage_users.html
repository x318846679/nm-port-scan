{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h2>用户管理</h2>
    <form id="user-form" method="POST" class="mb-4">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            {{ form.username.label(class="form-label") }}
            {{ form.username(class="form-control", size=32) }}
        </div>
        <div class="mb-3">
            {{ form.password.label(class="form-label") }}
            {{ form.password(class="form-control", size=32) }}
        </div>
        <div class="mb-3">
            {{ form.confirm.label(class="form-label") }}
            {{ form.confirm(class="form-control", size=32) }}
        </div>
        <div class="mb-3">
            {{ form.role.label(class="form-label") }}
            {{ form.role(class="form-select") }}
        </div>
        <div class="mb-3">
            {{ form.email.label(class="form-label") }}
            {{ form.email(class="form-control", size=32) }}
        </div>
        <div>
            {{ form.submit(class="btn btn-primary", id="create-user-btn") }}
        </div>
    </form>

    <h3>用户列表</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>用户名</th>
                <th>角色</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.role }}</td>
                <td>
                    <!-- 编辑和删除按钮 -->
                    <button class="btn btn-warning btn-sm edit-user-btn" 
                        data-user-id="{{ user.id }}">编辑</button>
                    <a href="{{ url_for('delete_user', id=user.id) }}"
                        class="btn btn-danger btn-sm"
                        onclick="return confirm('确定要删除这个用户吗？')">删除</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 编辑用户模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1"
    aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">编辑用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 模态框内容 -->
                <form id="editUserForm" method="POST">
                    {{ form.hidden_tag() }}
                    <input type="hidden" id="edit-user-id" name="user_id">
                    <div class="mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control", size=32, id="edit-username") }}
                    </div>
                    <div class="mb-3">
                        {{ form.password.label(class="form-label") }}
                        {{ form.password(class="form-control", size=32, id="edit-password") }}
                        <small class="form-text text-muted">留空则不修改密码</small>
                    </div>
                    <div class="mb-3">
                        {{ form.confirm.label(class="form-label") }}
                        {{ form.confirm(class="form-control", size=32, id="edit-confirm") }}
                    </div>
                    <div class="mb-3">
                        {{ form.role.label(class="form-label") }}
                        {{ form.role(class="form-select", id="edit-role") }}
                    </div>
                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control", size=32, id="edit-email") }}
                    </div>
                    <div>
                        <button type="submit"
                            class="btn btn-primary">保存更改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 创建用户表单提交事件
    $('#user-form').on('submit', function(e) {
        e.preventDefault();
        
        var formData = $(this).serialize();
        
        $.ajax({
            url: '/create-user',
            method: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert('用户创建成功');
                    location.reload();
                } else {
                    var errorMsg = '创建失败: ' + (response.error || '未知错误');
                    if (response.errors) {
                        errorMsg += '\n具体错误:\n';
                        for (var field in response.errors) {
                            errorMsg += field + ': ' + response.errors[field] + '\n';
                        }
                    }
                    alert(errorMsg);
                }
            },
            error: function(xhr) {
                var errorMsg = '创建失败';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                } else if (xhr.statusText) {
                    errorMsg += ': ' + xhr.statusText;
                }
                alert(errorMsg);
            }
        });
    });

    // 编辑用户按钮点击事件
    $('.edit-user-btn').on('click', function() {
        var userId = $(this).data('user-id');
        
        // 获取用户信息并填充表单
        $.ajax({
            url: '/get_user/' + userId,
            method: 'GET',
            success: function(data) {
                // 填充表单字段
                $('#edit-user-id').val(userId);
                $('#edit-username').val(data.username);
                $('#edit-role').val(data.role);
                $('#edit-email').val(data.email || '');
                
                // 清空密码字段
                $('#edit-password').val('');
                $('#edit-confirm').val('');
                
                // 显示模态框
                $('#editUserModal').modal('show');
            },
            error: function(xhr) {
                alert('获取用户信息失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
            }
        });
    });
    
    // 监听模态框关闭事件
    $('#editUserModal').on('hidden.bs.modal', function (e) {
        // 清空表单数据
        $('#editUserForm')[0].reset();
        // 清空可能存在的服务器端验证错误信息
        $('.invalid-feedback').remove();
        $('.is-invalid').removeClass('is-invalid');
    });

    // 编辑用户表单提交事件
    $('#editUserForm').on('submit', function(e) {
        e.preventDefault();
        
        var userId = $('#edit-user-id').val();
        var formData = $(this).serialize();
        
        $.ajax({
            url: '/edit-user/' + userId,
            method: 'POST',
            data: formData,
            success: function(response) {
                if (response.success !== undefined) {
                    if (response.success) {
                        // 关闭模态框
                        $('#editUserModal').modal('hide');
                        // 显示成功消息
                        alert('用户更新成功');
                        // 重新加载页面
                        location.reload();
                    } else {
                        alert('更新失败: ' + (response.error || '未知错误'));
                    }
                } else {
                    // 如果返回的是页面而不是JSON，说明成功了
                    $('#editUserModal').modal('hide');
                    location.reload();
                }
            },
            error: function(xhr) {
                alert('更新失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
            }
        });
    });
</script>
{% endblock %}