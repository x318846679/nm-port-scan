{% extends "layout.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">任务详情</h1>
            <div class="card mb-4">
                <div class="card-header">
                    <h2>{{ task.name }}</h2>
                </div>
                <div class="card-body">
                    <p><strong>参数:</strong> {{ task.params }}</p>
                    {% if task.template %}
                    <p><strong>参数模板:</strong> {{ task.template.name }}</p>
                    {% endif %}
                    <p><strong>邮件发送:</strong> {{ '是' if task.send_email else '否'
                        }}</p>
                    <p><strong>创建时间:</strong> {{ task.created_at }}</p>
                    <p><strong>创建者:</strong> {{ task.creator.username
                        }}</p>
                    
                    {% if task.asset %}
                    <p><strong>资产:</strong> {{ task.asset.name }}</p>
                    {% endif %}

                    <p><strong>IP地址:</strong></p>
                    <textarea class="form-control" rows="5"
                        readonly>{{ task.ips }}</textarea>
                </div>
                <div class="card-footer">
                    <button id="exportButton"
                        class="btn btn-primary">导出端口数据为Excel</button>
                </div>
            </div>
            
            {% if diff_data %}
            <div class="card mb-4">
                <div class="card-header">
                    <h3>与上次扫描对比</h3>
                </div>
                <div class="card-body">
                    <p><strong>上次扫描任务:</strong> {{ diff_data.previous_task.name }} ({{ diff_data.previous_task.created_at }})</p>
                    <div class="row">
                        <div class="col-md-4">
                            <h4>新增端口 ({{ diff_data.added_ports|length }})</h4>
                            {% if diff_data.added_ports %}
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>IP</th>
                                        <th>协议</th>
                                        <th>端口</th>
                                        <th>服务</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for port in diff_data.added_ports %}
                                    <tr>
                                        <td>{{ port.ip }}</td>
                                        <td>{{ port.agree }}</td>
                                        <td>{{ port.port }}</td>
                                        <td>{{ port.name }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p>无新增端口</p>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h4>减少端口 ({{ diff_data.removed_ports|length }})</h4>
                            {% if diff_data.removed_ports %}
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>IP</th>
                                        <th>协议</th>
                                        <th>端口</th>
                                        <th>服务</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for port in diff_data.removed_ports %}
                                    <tr>
                                        <td>{{ port.ip }}</td>
                                        <td>{{ port.agree }}</td>
                                        <td>{{ port.port }}</td>
                                        <td>{{ port.name }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p>无减少端口</p>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h4>保持不变的端口 ({{ diff_data.unchanged_ports|length }})</h4>
                            {% if diff_data.unchanged_ports %}
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>IP</th>
                                        <th>协议</th>
                                        <th>端口</th>
                                        <th>服务</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for port in diff_data.unchanged_ports %}
                                    <tr>
                                        <td>{{ port.ip }}</td>
                                        <td>{{ port.agree }}</td>
                                        <td>{{ port.port }}</td>
                                        <td>{{ port.name }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p>无保持不变的端口</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="card mb-4">
                <div class="card-header">
                    <h3>数据可视化</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>服务类型分布</h4>
                            <canvas id="serviceChart" width="400" height="400"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h4>端口变化趋势</h4>
                            <canvas id="trendChart" width="400" height="400"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>端口数据</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped mt-4" id="portTable">
                            <thead>
                                <tr>
                                    <th>IP</th>
                                    <th>协议</th>
                                    <th>端口</th>
                                    <th>服务</th>
                                    <th>Banner</th>
                                </tr>
                            </thead>
                            <tbody id="portTableBody">
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span>每页显示: </span>
                            <select id="pageSize" class="form-select d-inline w-auto">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div>
                            <button id="prevPage" class="btn btn-secondary">上一页</button>
                            <span id="pageInfo" class="mx-2">第 1 页，共 1 页</span>
                            <button id="nextPage" class="btn btn-secondary">下一页</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/xlsx.full.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
<script>
// 准备端口数据
var portsData = {{ ports_data|tojson }};
var diffData = {{ diff_data|tojson if diff_data else "{}" }};
var historyData = {{ history_data|tojson if history_data else "[]" }};

// 分页相关变量
let currentPage = 1;
let pageSize = 25;

// 统计服务类型
var serviceCounts = {};
portsData.forEach(function(port) {
    serviceCounts[port.name] = (serviceCounts[port.name] || 0) + 1;
});

document.getElementById('exportButton').addEventListener('click', function() {
    var wb = XLSX.utils.table_to_book(document.getElementById('portTable'), { sheet: "Sheet1" });
    XLSX.writeFile(wb, 'port_table.xlsx');
});

// 分页功能实现
function renderTablePage() {
    const tbody = document.getElementById('portTableBody');
    tbody.innerHTML = '';
    
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = portsData.slice(start, end);
    
    pageData.forEach(function(port) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${port.ip}</td>
            <td>${port.agree}</td>
            <td>${port.port}</td>
            <td>${port.name}</td>
            <td>${port.banner}</td>
        `;
        tbody.appendChild(row);
    });
    
    // 更新分页信息
    const totalPages = Math.ceil(portsData.length / pageSize);
    document.getElementById('pageInfo').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
    
    // 更新按钮状态
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
}

// 事件监听器
document.getElementById('prevPage').addEventListener('click', function() {
    if (currentPage > 1) {
        currentPage--;
        renderTablePage();
    }
});

document.getElementById('nextPage').addEventListener('click', function() {
    const totalPages = Math.ceil(portsData.length / pageSize);
    if (currentPage < totalPages) {
        currentPage++;
        renderTablePage();
    }
});

document.getElementById('pageSize').addEventListener('change', function() {
    pageSize = parseInt(this.value);
    currentPage = 1;
    renderTablePage();
});

// 初始化图表
document.addEventListener('DOMContentLoaded', function() {
    // 初始化表格分页
    renderTablePage();
    
    // 创建服务类型分布饼图
    if (Object.keys(serviceCounts).length > 0) {
        const serviceCtx = document.getElementById('serviceChart').getContext('2d');
        const serviceChart = new Chart(serviceCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(serviceCounts),
                datasets: [{
                    data: Object.values(serviceCounts),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(199, 199, 199, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '服务类型分布'
                    }
                }
            }
        });
    }
    
    // 创建端口变化趋势图
    if (historyData.length > 0) {
        // 准备趋势图数据
        const trendLabels = historyData.map(item => item.created_at);
        const trendData = historyData.map(item => item.port_count);
        
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: '端口数量',
                    data: trendData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '端口变化趋势'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}